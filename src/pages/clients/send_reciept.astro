---
export const prerender = false;

import Layout from "~/layouts/Layout.astro";
import RichSeo from "~/components/common/RichSeo.astro";
import LandingHeader from "~/components/widgets/LandingHeader.astro";
import ScrollToTopButton from "~/components/widgets/ScrollToTopButton.astro";
import WhatsAppButton from "~/components/widgets/WhatsAppButton.astro";

const richMetadata = {
  title: "×™×•×œ×™×” ×§×•×¨×Ÿ - ×”×¤×§×ª ×§×‘×œ×” ×œ×œ×§×•×—",
  description: "×”×¤×§×ª ×§×‘×œ×” ×•×©×œ×™×—×ª×” ×‘×•×•××˜×¡××¤",
};

const metadata = {
  title: "×™×•×œ×™×” ×§×•×¨×Ÿ | ×”×¤×§×ª ×§×‘×œ×” ×œ×œ×§×•×—",
  description: "×”×¤×§×ª ×§×‘×œ×” ×•×©×œ×™×—×ª×” ×‘×•×•××˜×¡××¤",
  ignoreTitleTemplate: true,
};
---

<Layout metadata={metadata}>
  <meta name="robots" content="noindex" />
  <div class="flex flex-col min-h-screen">
    <main class="flex-grow">
      <RichSeo metadata={richMetadata} />
      <LandingHeader isSticky />
      <ScrollToTopButton />

      <section class="bg-gray-50 py-16 px-6 text-center">
        <h1 class="text-3xl font-bold mb-4">×”×¤×§×ª ×§×‘×œ×” ×œ×œ×§×•×—</h1>
        <p class="text-lg text-gray-700 max-w-2xl mx-auto">
          ××¤×™×§×™× ×§×‘×œ×” ×‘×œ×—×™×¦×” ×•×©×•×œ×—×™× ××™×“ ×‘×•×•××˜×¡××¤ ğŸ“„
        </p>
      </section>

      <section class="max-w-2xl mx-auto py-12 px-6">
        <form id="receiptForm" class="space-y-6 bg-white p-8 rounded-2xl shadow-lg">

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <input type="tel" id="phone" placeholder="×˜×œ×¤×•×Ÿ ×œ×§×•×—" required
              class="border p-3 w-full rounded-lg focus:ring-2 focus:ring-primary focus:outline-none" />

            <input type="text" id="clientName" placeholder="×©× ×”×œ×§×•×—" readonly
              class="border p-3 w-full rounded-lg bg-gray-100 text-gray-600" />

            <input type="text" id="clientEmail" placeholder="××™×™×œ ×”×œ×§×•×—" readonly
              class="border p-3 w-full rounded-lg bg-gray-100 text-gray-600" />
          </div>

          <input type="number" id="amount" placeholder="×¡×›×•× ×©×©×•×œ× (â‚ª)" required
            class="border p-3 w-full rounded-lg focus:ring-2 focus:ring-primary focus:outline-none" />
        
            <input type="date" id="paymentDate" placeholder="×ª××¨×™×š ×”×ª×©×œ×•×" required class="border p-3 w-full h-12 rounded-lg focus:ring-2 focus:ring-primary focus:outline-none" />

          <select id="payment" required class="border p-3 w-full rounded-lg focus:ring-2 focus:ring-primary focus:outline-none">
            <option value="" disabled selected>×‘×—×¨×™ ×××¦×¢×™ ×ª×©×œ×•×</option>
            <option value="1">××–×•××Ÿ</option>
            <option value="4">×”×¢×‘×¨×” ×‘× ×§××™×ª</option>
            <option value="10" data-app="1">Bit</option>
            <option value="10" data-app="3">PayBox</option>
          </select>

          <input type="text" id="description" placeholder="×ª×™××•×¨ (×œ×“×•×’××”: ×ª×©×œ×•× ×¢×œ ×¡×©×Ÿ ××©×¤×—×”)" required
            class="border p-3 w-full rounded-lg focus:ring-2 focus:ring-primary focus:outline-none" />
          <input type="text" id="remarks" placeholder="×”×¢×¨×•×ª (×œ×“×•×’××: ×ª××¨×™×š ×”×¦×™×œ×•××™×)" required
            class="border p-3 w-full rounded-lg focus:ring-2 focus:ring-primary focus:outline-none" />

          <button type="submit" id="submit"
            class="btn-primary w-full py-3 px-6 rounded-xl bg-primary text-white font-bold hover:bg-primary-dark transition">
            ×”×¤×§×ª ×§×‘×œ×” ×•×©×œ×™×—×” ×œ×œ×§×•×—
          </button>

        </form>
      </section>
    </main>

    <footer class="bg-footer text-white py-8 text-center">
        <button
        aria-label="Footer Scroll to top" 
        id="scrollToTopFooter"
        class="hidden p-3 bg-gray-800/30 w-13 text-white rounded-lg shadow-md border border-white/80 backdrop-blur-sm focus-visible:outline-hidden focus-visible:ring-3 focus-visible:ring-primary dark:focus-visible:ring-gray-200 transition ease-in duration-200"
    >
        <span class="sr-only">Footer Scroll to top</span> â†‘
    </button>
      <p class="mb-4 font-bold">×™×•×œ×™×” ×§×•×¨×Ÿ | yulia.photography</p>
      <p>×”×¤×§×ª ×§×‘×œ×” â¤ï¸</p>
    </footer>
  </div>

  <WhatsAppButton />
</Layout>

<script>
  function initReceiptForm() {

    const phoneInput = document.getElementById("phone");
    const nameField = document.getElementById("clientName");
    const emailField = document.getElementById("clientEmail");

    const amount = document.getElementById("amount");
    const payment = document.getElementById("payment");
    const paymentDate = document.getElementById("paymentDate");
    const description = document.getElementById("description");
    const remarks = document.getElementById("remarks");

    const form = document.getElementById("receiptForm");
    const submitButton = document.getElementById("submit");

    let timeout;
    let lastPhone = "";

    phoneInput.addEventListener("input", (e) => {
      const digits = e.target.value.replace(/\D/g, "");
      let formatted = digits;
      if (digits.length > 3) formatted = digits.slice(0,3)+"-"+digits.slice(3);
      e.target.value = formatted;

      clearTimeout(timeout);

      if (digits.length >= 10)
        timeout = setTimeout(() => lookup(digits), 400);
      else {
        nameField.value = "";
        emailField.value = "";
      }
    });

    async function lookup(phone) {
      if (phone === lastPhone) return;
      lastPhone = phone;

      nameField.value = "××—×¤×©...";

      const res = await fetch("/api/get_client_for_receipt", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({ phone })
      });

      const data = await res.json();

      if (!res.ok) {
        nameField.value = "×œ× × ××¦× ×œ×§×•×—";
        emailField.value = "";
      } else {
        nameField.value = data.name;
        emailField.value = data.email ?? "";
      }
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const digits = phoneInput.value.replace(/\D/g, "");
      if (digits.length < 10) return alert("××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×œ× ×ª×§×™×Ÿ");

      submitButton.disabled = true;
      submitButton.textContent = "×©×•×œ×—...";

      const selectedOption = payment.options[payment.selectedIndex];
      const appType = selectedOption.dataset.app || null;

      const res = await fetch("/api/create_receipt", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({
          phone: digits,
          name: nameField.value,
          email: emailField.value,
          amount: Number(amount.value),
          payment: Number(payment.value),
          appType: appType,
          paymentDate: new Date(paymentDate.value).toISOString().split('T')[0],
          description: description.value,
          remarks: remarks.value
        })
      });

      const data = await res.json();

      if (!res.ok) {
        alert("×©×’×™××” ×‘×”×¤×§×ª ×§×‘×œ×”");
        console.error(data);
        return;
      }

      let waPhone = digits.startsWith("0")
        ? "972" + digits.slice(1)
        : digits;

      const msg = encodeURIComponent(
        `×”×™×™!\n` +
        `×”×§×‘×œ×” ×©×œ×š ××•×›× ×”\n\n` +
        `×œ×™× ×§ ×œ×”×•×¨×“×”:\n` +
        `${data.url}`
      );
      window.open(`https://wa.me/${waPhone}?text=${msg}`, "_blank");
    });

  }

  document.addEventListener("astro:page-load", initReceiptForm);
</script>