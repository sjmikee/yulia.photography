---
export const prerender = false;

import Layout from "~/layouts/Layout.astro";
import RichSeo from "~/components/common/RichSeo.astro";
import LandingHeader from "~/components/widgets/LandingHeader.astro";
import ScrollToTopButton from "~/components/widgets/ScrollToTopButton.astro";
import WhatsAppButton from "~/components/widgets/WhatsAppButton.astro";

const richMetadata = {
  title: " 拽专 - 砖转  拽",
  description: "砖转  拽 拽 专 WhatsApp",
};

const metadata = {
  title: " 拽专 | 砖转  拽",
  description: "砖转  拽 拽 专 WhatsApp",
  ignoreTitleTemplate: true,
};
---

<Layout metadata={metadata}>
  <meta name="robots" content="noindex" />
  <RichSeo metadata={richMetadata} />
  <LandingHeader isSticky />
  <ScrollToTopButton />

  <section class="bg-gray-50 py-16 px-6 text-center">
    <h1 class="text-3xl font-bold mb-4">砖转  拽</h1>
    <p class="text-lg text-gray-700 max-w-2xl mx-auto">
      砖  爪 转 专 住驻 
    </p>
  </section>

  <section class="max-w-2xl mx-auto py-12 px-6">
    <form id="whatsappForm" class="space-y-6 bg-white p-8 rounded-2xl shadow-lg">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <input type="tel" id="phone" placeholder="驻 拽" required
               class="border p-3 w-full rounded-lg focus:ring-2 focus:ring-primary focus:outline-none" />

        <input type="text" id="clientName" placeholder="砖 拽" readonly
               class="border p-3 w-full rounded-lg bg-gray-100 text-gray-600" />

        <input type="text" id="clientEmail" placeholder=" 拽" readonly
               class="border p-3 w-full rounded-lg bg-gray-100 text-gray-600" />
      </div>

      <button type="submit" class="btn-primary w-full py-3 px-6 rounded-xl bg-primary text-white font-bold hover:bg-primary-dark transition">
        砖转 
      </button>
    </form>
  </section>

  <footer class="bg-footer text-white py-8 text-center">
    <p class="mb-4 font-bold"> 拽专 | yulia.photography</p>
    <p>砖转  わ</p>
  </footer>

  <WhatsAppButton />

  <script>
    const phoneInput = document.getElementById("phone");
    const nameField = document.getElementById("clientName");
    const emailField = document.getElementById("clientEmail");
    const form = document.getElementById("whatsappForm");

    let lastFetchedPhone = "";
    let lookupTimeout;

    phoneInput?.addEventListener("input", (e) => {
      const digits = e.target.value.replace(/\D/g, "");
      let formatted = digits;
      if (digits.length > 3) formatted = digits.slice(0, 3) + "-" + digits.slice(3);
      e.target.value = formatted;

      clearTimeout(lookupTimeout);
      if (digits.length >= 9) lookupTimeout = setTimeout(() => lookupClient(digits), 400);
      else {
        nameField.value = "";
        emailField.value = "";
      }
    });

    async function lookupClient(phoneDigits) {
      if (phoneDigits === lastFetchedPhone) return;
      lastFetchedPhone = phoneDigits;

      nameField.value = "驻砖...";
      try {
        const res = await fetch("/api/get_client_by_phone", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ phone: phoneDigits }),
        });
        const data = await res.json();
        if (!res.ok) {
          nameField.value = " 爪 拽";
          emailField.value = "";
        } else {
          nameField.value = data.name;
          emailField.value = data.email || "";
        }
      } catch {
        nameField.value = "砖 驻砖";
        emailField.value = "";
      }
    }

    form.addEventListener("submit", (e) => {
      e.preventDefault();

      const rawPhone = phoneInput.value.replace(/\D/g, "");
      if (!rawPhone) return alert("  住驻专 驻");

      let waPhone = rawPhone;
      if (waPhone.startsWith("0")) waPhone = "972" + waPhone.slice(1);

      const contractLink = `https://yulia.photography/contract?phone=${rawPhone}`;
      const message = encodeURIComponent(contractLink);
      const waUrl = `https://wa.me/${waPhone}?text=${message}`;

      window.open(waUrl, "_blank");
    });
  </script>
</Layout>