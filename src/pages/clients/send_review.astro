---
export const prerender = false;

import Layout from "~/layouts/Layout.astro";
import RichSeo from "~/components/common/RichSeo.astro";
import LandingHeader from "~/components/widgets/LandingHeader.astro";
import ScrollToTopButton from "~/components/widgets/ScrollToTopButton.astro";
import WhatsAppButton from "~/components/widgets/WhatsAppButton.astro";

const richMetadata = {
  title: "יוליה קורן - שליחת קישור לביקורת גוגל",
  description: "שליחת קישור לכתיבת ביקורת גוגל ללקוח קיים דרך WhatsApp",
};

const metadata = {
  title: "יוליה קורן | שליחת ביקורת גוגל",
  description: "שליחת קישור לכתיבת ביקורת גוגל ללקוח קיים דרך WhatsApp",
  ignoreTitleTemplate: true,
};
---

<Layout metadata={metadata}>
  <meta name="robots" content="noindex" />
  <div class="flex flex-col min-h-screen">
    <main class="flex-grow">
  <RichSeo metadata={richMetadata} />
  <LandingHeader isSticky />
  <ScrollToTopButton />

  <section class="bg-gray-50 py-16 px-6 text-center">
    <h1 class="text-3xl font-bold mb-4">שליחת ביקורת גוגל</h1>
    <p class="text-lg text-gray-700 max-w-2xl mx-auto">
      שולחים קישור לכתיבת ביקורת גוגל דרך וואטסאפ 🌟
    </p>
  </section>

  <section class="max-w-2xl mx-auto py-12 px-6">
    <form id="whatsappForm" class="space-y-6 bg-white p-8 rounded-2xl shadow-lg">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <input type="tel" id="phone" placeholder="טלפון לקוח" required
               class="border p-3 w-full rounded-lg focus:ring-2 focus:ring-primary focus:outline-none" />

        <input type="text" id="clientName" placeholder="שם הלקוח" readonly
               class="border p-3 w-full rounded-lg bg-gray-100 text-gray-600" />
      </div>

      <button type="submit" class="btn-primary w-full py-3 px-6 rounded-xl bg-primary text-white font-bold hover:bg-primary-dark transition">
        שליחת קישור לביקורת
      </button>
    </form>
  </section>
  </main>

  <footer class="bg-footer text-white py-8 text-center">
    <button
        aria-label="Footer Scroll to top" 
        id="scrollToTopFooter"
        class="hidden p-3 bg-gray-800/30 w-13 text-white rounded-lg shadow-md border border-white/80 backdrop-blur-sm focus-visible:outline-hidden focus-visible:ring-3 focus-visible:ring-primary dark:focus-visible:ring-gray-200 transition ease-in duration-200"
    >
        <span class="sr-only">Footer Scroll to top</span> ↑
    </button>
    <p class="mb-4 font-bold">יוליה קורן | yulia.photography</p>
    <p>שליחת קישור לביקורת ❤️</p>
  </footer>
  </div>

  <WhatsAppButton />

  <script>
    const phoneInput = document.getElementById("phone");
    const nameField = document.getElementById("clientName");
    const form = document.getElementById("whatsappForm");

    let lastFetchedPhone = "";
    let lookupTimeout;

    phoneInput?.addEventListener("input", (e) => {
      const digits = e.target.value.replace(/\D/g, "");
      let formatted = digits;
      if (digits.length > 3) formatted = digits.slice(0, 3) + "-" + digits.slice(3);
      e.target.value = formatted;

      clearTimeout(lookupTimeout);
      if (digits.length >= 9) lookupTimeout = setTimeout(() => lookupClient(digits), 400);
      else {
        nameField.value = "";
      }
    });

    async function lookupClient(phoneDigits) {
      if (phoneDigits === lastFetchedPhone) return;
      lastFetchedPhone = phoneDigits;

      nameField.value = "מחפש...";
      try {
        const res = await fetch("/api/get_client_by_phone", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ phone: phoneDigits }),
        });
        const data = await res.json();
        if (!res.ok) {
          nameField.value = "לא נמצא לקוח";
        } else {
          nameField.value = data.name;
        }
      } catch {
        nameField.value = "שגיאה בחיפוש";
      }
    }

    form.addEventListener("submit", (e) => {
      e.preventDefault();

      const rawPhone = phoneInput.value.replace(/\D/g, "");
      if (!rawPhone) return alert("אנא הזיני מספר טלפון");

      let waPhone = rawPhone;
      if (waPhone.startsWith("0")) waPhone = "972" + waPhone.slice(1);

      const reviewLink = "https://g.page/r/CfFq0GZG4TgjEBE/review";
      const message = encodeURIComponent(`אשמח אם תכתבו לי ביקורת ❤️\n${reviewLink}`);
      const waUrl = `https://wa.me/${waPhone}?text=${message}`;

      window.open(waUrl, "_blank");
    });
  </script>
</Layout>