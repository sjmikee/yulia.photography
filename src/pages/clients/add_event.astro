---
export const prerender = false;

import Layout from "~/layouts/Layout.astro";
import RichSeo from "~/components/common/RichSeo.astro";
import LandingHeader from "~/components/widgets/LandingHeader.astro";
import ScrollToTopButton from "~/components/widgets/ScrollToTopButton.astro";
import WhatsAppButton from "~/components/widgets/WhatsAppButton.astro";

const richMetadata = {
  title: "×™×•×œ×™×” ×§×•×¨×Ÿ - ×”×•×¡×¤×ª ××™×¨×•×¢ ×œ×™×•××Ÿ",
  description: "×”×•×¡×¤×ª ××™×¨×•×¢ ×—×“×© ×‘×’×•×’×œ ×§×œ× ×“×¨ ×œ×œ×§×•×— ×§×™×™×",
};

const metadata = {
  title: "×™×•×œ×™×” ×§×•×¨×Ÿ | ×”×•×¡×¤×ª ××™×¨×•×¢ ×œ×™×•××Ÿ",
  description: "×”×•×¡×¤×ª ××™×¨×•×¢ ×—×“×© ×‘×’×•×’×œ ×§×œ× ×“×¨ ×œ×œ×§×•×— ×§×™×™×",
  ignoreTitleTemplate: true,
};
---

<Layout metadata={metadata}>
  <meta name="robots" content="noindex" />
  <RichSeo metadata={richMetadata} />
  <LandingHeader isSticky />
  <ScrollToTopButton />

  <!-- Hero Section -->
  <section class="bg-gray-50 py-16 px-6 text-center">
    <h1 class="text-3xl font-bold mb-4">×”×•×¡×¤×ª ×œ×§×•×— ×œ×™×•××Ÿ</h1>
    <p class="text-lg text-gray-700 max-w-2xl mx-auto">
      ×§×•×‘×¢×™× ×¦×™×œ×•××™× ×‘×§×œ×™×§ ××—×“ ğŸ¯
    </p>
  </section>

  <!-- Add Event Form -->
  <section class="max-w-4xl mx-auto py-12 px-6">
    <form id="calendarForm" class="space-y-6 bg-white p-8 rounded-2xl shadow-lg">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <input type="tel" id="phone" placeholder="×˜×œ×¤×•×Ÿ ×œ×§×•×—" required class="border p-3 w-full rounded-lg focus:ring-2 focus:ring-primary focus:outline-none" />
        <input type="text" id="clientName" placeholder="×©×" readonly class="border p-3 w-full rounded-lg bg-gray-100 text-gray-600" />
        <input type="text" id="clientEmail" placeholder="××™×™×œ" readonly class="border p-3 w-full rounded-lg bg-gray-100 text-gray-600" />
        <label class="block">×ª××¨×™×š:</label>
        <input type="date" id="date" placeholder="×‘×—×¨ ×ª××¨×™×š" required class="border p-3 w-full h-12 rounded-lg focus:ring-2 focus:ring-primary focus:outline-none" />
        <label class="block">×©×¢×”:</label>
        <input type="time" id="time" placeholder="×‘×—×¨ ×©×¢×”" required class="border p-3 w-full h-12 rounded-lg focus:ring-2 focus:ring-primary focus:outline-none" />
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <select id="sessionType" required class="border p-3 w-full rounded-lg focus:ring-2 focus:ring-primary focus:outline-none">
          <option value="" disabled selected>×‘×—×¨ ×¡×•×’ ×¦×™×œ×•××™×</option>
          <option value="×¦×™×œ×•××™× ××™×©×™×™×">×¦×™×œ×•××™× ××™×©×™×™×</option>
          <option value="×¦×™×œ×•××™ ×–×•×’×™×•×ª">×¦×™×œ×•××™ ×–×•×’×™×•×ª</option>
          <option value="×¦×™×œ×•××™ ××©×¤×—×”">×¦×™×œ×•××™ ××©×¤×—×”</option>
          <option value="×¦×™×œ×•××™ ×™×œ×“×™×">×¦×™×œ×•××™ ×™×œ×“×™×</option>
        </select>

        <select id="duration" required class="border p-3 w-full rounded-lg focus:ring-2 focus:ring-primary focus:outline-none">
          <option value="" disabled selected>×‘×—×¨ ××©×š</option>
          <option value="1">1 ×©×¢×•×ª</option>
          <option value="2">2 ×©×¢×•×ª</option>
          <option value="3">3 ×©×¢×•×ª</option>
          <option value="4">4 ×©×¢×•×ª</option>
        </select>
      </div>

      <button type="submit" class="btn-primary w-full py-3 px-6 rounded-xl bg-primary text-white font-bold hover:bg-primary-dark transition">
        ×”×•×¡×¤×”
      </button>
    </form>
  </section>

  <!-- Footer & WhatsApp -->

  <footer class="bg-footer text-white py-8 text-center">
    <button
        aria-label="Footer Scroll to top" 
        id="scrollToTopFooter"
        class="hidden p-3 bg-gray-800/30 w-13 text-white rounded-lg shadow-md border border-white/80 backdrop-blur-sm focus-visible:outline-hidden focus-visible:ring-3 focus-visible:ring-primary dark:focus-visible:ring-gray-200 transition ease-in duration-200"
    >
        <span class="sr-only">Footer Scroll to top</span> â†‘
    </button>
    <p class="mb-4 font-bold">×™×•×œ×™×” ×§×•×¨×Ÿ | yulia.photography</p>
    <p>×”×•×¡×¤×ª ××™×¨×•×¢ ×œ×™×•××Ÿ â¤ï¸</p>
  </footer>

  <WhatsAppButton />

  <WhatsAppButton />

  <!-- Scripts -->

  <script>
    const phoneInput = document.getElementById("phone");
    const nameField = document.getElementById("clientName");
    const form = document.getElementById("calendarForm");

    let lastFetchedPhone = "";
    let lookupTimeout;
    let clientEmail = "";

    // Auto-format and lookup
    phoneInput.addEventListener("input", (e) => {
      const digits = e.target.value.replace(/\D/g, "");
      let formatted = digits;
      if (digits.length > 3) formatted = digits.slice(0, 3) + "-" + digits.slice(3);
      e.target.value = formatted;

      clearTimeout(lookupTimeout);
      if (digits.length >= 9) lookupTimeout = setTimeout(() => lookupClient(digits), 400);
      else {
        nameField.value = "";
        document.getElementById("clientEmail").value = "";
        clientEmail = "";
      }
    });

    async function lookupClient(phoneDigits) {
      if (phoneDigits === lastFetchedPhone) return;
      lastFetchedPhone = phoneDigits;

      nameField.value = "××—×¤×©...";
      try {
        const res = await fetch("/api/get_client_by_phone", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ phone: phoneDigits }),
        });
        const data = await res.json();
        if (!res.ok) {
          nameField.value = "×œ× × ××¦× ×œ×§×•×—";
          nameField.classList.add("text-gray-400");
          document.getElementById("clientEmail").value = "";
          clientEmail = "";
        } else {
          nameField.value = data.name;
          document.getElementById("clientEmail").value = data.email || "";
          nameField.classList.remove("text-gray-400");
          clientEmail = data.email || "";
        }
      } catch {
        nameField.value = "×©×’×™××” ×‘×—×™×¤×•×©";
        nameField.classList.add("text-gray-400");
        document.getElementById("clientEmail").value = "";
        clientEmail = "";
      }
    }

    form.addEventListener("submit", (e) => {
      e.preventDefault();

      const phone = phoneInput.value.replace(/\D/g, "");
      const name = nameField.value.trim();
      const email = clientEmail;
      const MKemail = "sjmikee@gmail.com";
      const date = document.getElementById("date").value;
      const time = document.getElementById("time").value;
      const sessionType = document.getElementById("sessionType").value;
      const duration = parseInt(document.getElementById("duration").value);

      if (!phone || !name || !date || !time || !sessionType || !duration) {
        Swal.fire({ icon: "warning", title: "× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª", timer: 1500, showConfirmButton: false });
        return;
      }

      if (["×œ× × ××¦× ×œ×§×•×—", "×©×’×™××” ×‘×—×™×¤×•×©", "××—×¤×©..."].includes(name)) {
        Swal.fire({ icon: "error", title: "×œ× × ××¦× ×œ×§×•×— ×¢×‘×•×¨ ××¡×¤×¨ ×–×”", timer: 1500, showConfirmButton: false });
        return;
      }

      const startDate = new Date(`${date}T${time}:00`);
      const endDate = new Date(startDate.getTime() + duration * 60 * 60 * 1000);
      const formatDate = (d) => d.toISOString().replace(/[-:]/g, "").split(".")[0] + "Z";

      const startStr = formatDate(startDate);
      const endStr = formatDate(endDate);

      const base = "https://calendar.google.com/calendar/render?action=TEMPLATE";
      const text = encodeURIComponent(`${sessionType} - ${name}`);
      const details = encodeURIComponent(`×œ×§×•×—: ${name}\n×˜×œ×¤×•×Ÿ: ${phone}\n×¡×•×’ ×¦×™×œ×•××™×: ${sessionType}\n××©×š: ${duration} ×©×¢×•×ª`);
      const dates = `${startStr}/${endStr}`;
      const url = `${base}&text=${text}&details=${details}&dates=${dates}&add=${encodeURIComponent(email)},${encodeURIComponent(MKemail)}`;

      window.open(url, "_blank");
    });
  </script>

  <!-- <style>
    input[type="date"]::-webkit-inner-spin-button,
    input[type="time"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
  </style> -->
</Layout>